#!/bin/sh

FW_CFG_PATH="/sys/firmware/qemu_fw_cfg/by_name/opt/guest/flag_content/raw"
DEST_FLAG_PATH="/flag"

if [ -e "$FW_CFG_PATH" ]; then
    if cp -f "$FW_CFG_PATH" "$DEST_FLAG_PATH"; then
        chown root:root "$DEST_FLAG_PATH"
        chmod 400 "$DEST_FLAG_PATH" # Read-only for root
        echo "Guest $DEST_FLAG_PATH created from fw_cfg."

        # Check if the flag file has content before trying to set the password
        if [ -s "$DEST_FLAG_PATH" ]; then
            FLAG_PASSWORD=$(cat "$DEST_FLAG_PATH")

            if [ -n "$FLAG_PASSWORD" ]; then
                echo "Attempting to set root password..."
                echo "root:${FLAG_PASSWORD}" | chpasswd
                if [ $? -eq 0 ]; then
                    echo "Root password successfully changed to the content of $DEST_FLAG_PATH."
                else
                    echo "Error: Failed to change root password using chpasswd."
                fi
            else
                echo "Error: $DEST_FLAG_PATH is empty. Root password not changed."
            fi
        else
            echo "Error: $DEST_FLAG_PATH was created but is empty. Root password not changed."
        fi
    else
        echo "Error: Failed to copy $FW_CFG_PATH to $DEST_FLAG_PATH."
    fi
else
    echo "Error: fw_cfg entry for flag not found at $FW_CFG_PATH. Root password not changed."
fi
