#include <linux/module.h>
#include <linux/proc_fs.h>
#include <linux/uaccess.h>
#include <linux/kernel.h>
#include <linux/fs.h>
#include <linux/string.h>

#define BUFFER_SIZE 0x80

int machoke_chance = 1;
char buffer[BUFFER_SIZE] = {0};
static struct proc_dir_entry *machoke_proc_file;


static ssize_t read_flag(size_t length, loff_t *offset)
{
	ssize_t bytes_read;
	struct file *flag;
	char * flag_path = "/flag";

	flag = filp_open(flag_path, O_RDONLY, 0);
	if (IS_ERR(flag)) {
		printk(KERN_ERR "Failed to open file %s\n", flag_path);
		return -ENOENT;
	}

	memset(buffer, 0, sizeof(buffer));
	length = length > BUFFER_SIZE ? BUFFER_SIZE : length;
	bytes_read = kernel_read(flag, buffer, length, offset);
	if (bytes_read < 0) {
		printk(KERN_ERR "Failed to read bytes: %ld\n", bytes_read);
		filp_close(flag, NULL);
		return bytes_read;
	}

	printk(KERN_INFO "read flag done\n");

	filp_close(flag, NULL);

	return 0;
}

static ssize_t machoke_proc_read(struct file *file, char *uptr, size_t count, loff_t *off) 
{
	if (machoke_chance-- <= 0) {
		return -EPERM;
	}
	
	printk(KERN_INFO "machoke read\n");

	count = count > BUFFER_SIZE ? BUFFER_SIZE : count;
	if (copy_to_user((void __user *)uptr, buffer, count)) {
		printk(KERN_ERR "Failed to copy data to user\n");
		return -EFAULT;
	}

	return count;
}

static struct proc_ops machoke_proc_fops= {
        .proc_read     = machoke_proc_read,
};

static int __init machoke_driver_init(void)
{
	printk(KERN_INFO "Welcome to kernel challenge machoke\n");

	read_flag(BUFFER_SIZE, 0);
	
	machoke_proc_file = proc_create("machoke", 0644, NULL, &machoke_proc_fops);
	if (!machoke_proc_file) {
		printk(KERN_ERR "Failed to create machoke proc file\n");
		return -ENOMEM;
	}

	printk(KERN_INFO "machoke initialized\n");
	
	return 0;
}

static void __exit machoke_driver_exit(void)
{
	proc_remove(machoke_proc_file);
	printk(KERN_INFO "machoke exited\n");
}

module_init(machoke_driver_init);
module_exit(machoke_driver_exit);

MODULE_LICENSE("GPL");
MODULE_AUTHOR("dangdang777 <dddddd@hust.edu.cn>");
MODULE_DESCRIPTION("A Tutorial Module For Kernel Exploitation Experiments");
